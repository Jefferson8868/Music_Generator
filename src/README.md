# 五色音乐匹配系统

五色音乐匹配系统是一个基于中国传统五行理论的音乐推荐工具，通过分析传统五色值（青、赤、黄、白、黑）序列，匹配最相似的音乐文件。系统结合了传统文化理论与现代音频分析技术，为用户提供符合特定情绪和音乐特性的音乐推荐。

## 系统原理

### 五行理论基础

系统基于中国传统五行理论，建立了以下映射关系：

| 五行 | 五色 | 五音 | 音高 | 情绪特征 |
|------|------|------|------|----------|
| 木   | 青   | 角   | E    | 生长、希望、平和、安宁 |
| 火   | 赤   | 徵   | G    | 热情、兴奋、喜悦、激昂 |
| 土   | 黄   | 宫   | C    | 稳重、中正、祥和、温暖 |
| 金   | 白   | 商   | D    | 肃穆、清澈、悲伤、凄凉 |
| 水   | 黑   | 羽   | A    | 神秘、深沉、恐惧、压抑 |

### 算法流程

1. **五色序列分析**：将输入的五色序列转换为五音分布和情绪特征向量
2. **音乐特征提取**：从音乐文件中提取声学特征和情绪特征
3. **相似度计算**：计算五色序列与音乐文件之间的多维相似度
4. **音乐匹配**：根据相似度排序，推荐最匹配的音乐文件

## 特征提取技术

### 五色序列特征提取

1. **五音分布分析**：
   - 将五色序列转换为五音序列（宫、商、角、徵、羽）
   - 计算各五音的出现频率分布

2. **情绪特征分析**：
   - 基于五色到情绪的映射关系，生成情绪关键词
   - 将情绪关键词转换为音乐特征向量

### 音乐文件特征提取

系统使用librosa库提取以下音频特征：

1. **节奏特征**：
   - 速度估计（Tempo）：表示音乐的快慢，单位为BPM（每分钟拍数）

2. **音高特征**：
   - 色度图（Chroma）：表示12音阶的能量分布
   - 调性中心（Key）：表示音乐的主要调性

3. **音色特征**：
   - 梅尔频率倒谱系数（MFCC）：描述音频的音色特征
   - 频谱中心（Spectral Centroid）：表示声音的"亮度"

4. **能量特征**：
   - 均方根能量（RMS Energy）：表示音频的响度
   - 能量标准差：表示能量的变化程度

5. **其他特征**：
   - 频谱对比度（Spectral Contrast）：表示音频频谱的峰谷对比
   - 零交叉率（Zero Crossing Rate）：表示音频信号符号变化的频率
   - 频谱平坦度（Spectral Flatness）：表示频谱的平坦程度
   - 频谱带宽（Bandwidth）：表示频谱的扩散程度

## 情绪分析方法

系统采用两种方法进行情绪分析：

1. **基于规则的情绪映射**：
   - 将五色映射到传统情绪（怒、喜、思、忧、恐）
   - 将情绪关键词映射到具体音乐特征（如舒缓、激昂、深沉等）

2. **机器学习情绪分析**（增强版）：
   - 使用LogisticRegression模型基于音乐特征预测情绪概率
   - 通过MultiOutputClassifier支持多情绪标签分类
   - 当标记数据不足时，回退到简单匹配算法

## 相似度计算

系统计算三种相似度并综合评分：

1. **五音相似度**：
   - 将五音分布转换为12音阶分布
   - 与音乐的色度特征计算余弦相似度

2. **文件名情绪相似度**：
   - 分析音乐文件名中的情绪关键词
   - 与五色情绪特征向量计算余弦相似度

3. **音乐特征情绪相似度**：
   - 基于音乐声学特征推断情绪特征
   - 与五色情绪特征向量计算余弦相似度

最终相似度计算公式：
```
综合相似度 = 0.3 * 五音相似度 + 0.4 * 文件名情绪相似度 + 0.3 * 音乐特征情绪相似度
```

## 使用方法

1. 运行程序：
   ```
   python color_music_matcher.py
   ```
   或使用增强版：
   ```
   python wuxing_music_matcher.py
   ```

2. 输入一串中国传统五色值，总数为100个字符，例如：
   ```
   青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑青青赤赤黄黄白白黑黑
   ```

3. 程序将分析五色序列，并显示：
   - 五音分布分析结果
   - 情绪特征分析结果
   - 最相似的5个音乐文件及其相似度分数
   - 可视化分析图表

## 输入输出格式

### 输入格式

- 输入为一串中国传统五色值（青、赤、黄、白、黑）
- 理想长度为100个字符
- 系统会自动过滤无效字符，只保留有效的五色值

### 输出格式

1. **五音分析结果**：
   ```
   五音分析结果:
   宫: 20.00%
   商: 20.00%
   角: 20.00%
   徵: 20.00%
   羽: 20.00%
   ```

2. **情绪分析结果**：
   ```
   情绪分析结果:
   平和: 15.00%
   温暖: 12.50%
   深沉: 10.00%
   舒缓: 8.75%
   和谐: 7.50%
   ```

3. **音乐匹配结果**：
   ```
   最相似的音乐文件:
   1. 安静舒缓优雅的背景音乐.mp3
      综合相似度: 85.23%
      五音相似度: 78.45%
      文件名情绪相似度: 92.31%
      音乐特征情绪相似度: 83.67%
   ```

## 特征存储

系统会将提取的音乐特征存储在JSON文件中，以加快后续分析：

- `all_music_features.json`：存储所有音乐文件的完整特征信息
- `music_emotions.json`：存储音乐文件的情绪概率向量

## 依赖库

- numpy：数值计算
- librosa：音频特征提取
- matplotlib：数据可视化
- scipy：科学计算（距离计算等）
- sklearn：机器学习算法（增强版）

## 注意事项

- 首次运行时，程序会提取音乐文件的特征，可能需要一些时间
- 确保输入的五色值只包含：青、赤、黄、白、黑
- 程序会自动忽略无效的字符
- 音乐文件应放置在`music_files`目录下
- 支持的音乐格式为MP3